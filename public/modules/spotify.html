<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Spotify Control</title>
  
  <!-- ==========================================
       MODULE CONFIGURATION
       ========================================== -->
  <script type="application/json" id="module-config">
  {
    "id": "spotify",
    "name": "Music",
    "type": "Modul",
    "priority": 3,
    "borderColor": "#0d5c1f",
    "activeColor": "#1DB954",
    "hasControllerUI": true,
    "hasOverlay": false,
    "dependencies": []
  }
  </script>
  
  <!-- ==========================================
       SERVER MODULE CODE
       ========================================== -->
  <script type="text/x-server-module">
// Initialize Spotify state
if (!moduleStates.spotify) {
  moduleStates.spotify = {
    tokens: {
      access_token: null,
      refresh_token: null,
      expires_at: null
    }
  };
}

const spotifyTokens = moduleStates.spotify.tokens;

const SPOTIFY_CLIENT_ID = process.env.SPOTIFY_CLIENT_ID || '';
const SPOTIFY_CLIENT_SECRET = process.env.SPOTIFY_CLIENT_SECRET || '';
const REDIRECT_URI = process.env.REDIRECT_URI || 'http://localhost:3000/callback';

// Helper function to refresh token
async function refreshSpotifyToken() {
  if (!spotifyTokens.refresh_token) return false;
  
  const fetch = (...args) => import('node-fetch').then(({default: fetch}) => fetch(...args));
  
  try {
    const response = await fetch('https://accounts.spotify.com/api/token', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/x-www-form-urlencoded',
        'Authorization': 'Basic ' + Buffer.from(SPOTIFY_CLIENT_ID + ':' + SPOTIFY_CLIENT_SECRET).toString('base64')
      },
      body: new URLSearchParams({
        grant_type: 'refresh_token',
        refresh_token: spotifyTokens.refresh_token
      })
    });
    
    const data = await response.json();
    
    spotifyTokens.access_token = data.access_token;
    spotifyTokens.expires_at = Date.now() + (data.expires_in * 1000);
    
    console.log('[SPOTIFY] Token refreshed');
    return true;
  } catch (err) {
    console.error('[SPOTIFY] Refresh error:', err);
    return false;
  }
}

// Helper function for Spotify API requests
async function spotifyRequest(endpoint, options = {}) {
  if (!spotifyTokens.access_token) {
    throw new Error('Not authenticated');
  }
  
  if (Date.now() >= spotifyTokens.expires_at) {
    await refreshSpotifyToken();
  }
  
  const fetch = (...args) => import('node-fetch').then(({default: fetch}) => fetch(...args));
  
  const response = await fetch(`https://api.spotify.com/v1${endpoint}`, {
    ...options,
    headers: {
      ...options.headers,
      'Authorization': `Bearer ${spotifyTokens.access_token}`
    }
  });
  
  if (!response.ok && response.status !== 204) {
    throw new Error(`Spotify API error: ${response.status}`);
  }
  
  if (response.status === 204) {
    return null;
  }
  
  return response.json();
}

// Routes
app.get('/spotify/login', (req, res) => {
  const scopes = 'user-read-playback-state user-modify-playback-state';
  const authUrl = `https://accounts.spotify.com/authorize?response_type=code&client_id=${SPOTIFY_CLIENT_ID}&scope=${encodeURIComponent(scopes)}&redirect_uri=${encodeURIComponent(REDIRECT_URI)}`;
  res.redirect(authUrl);
});

app.get('/callback', async (req, res) => {
  const code = req.query.code;
  
  if (!code) {
    return res.send('<script>window.close();</script>');
  }
  
  const fetch = (...args) => import('node-fetch').then(({default: fetch}) => fetch(...args));
  
  try {
    const response = await fetch('https://accounts.spotify.com/api/token', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/x-www-form-urlencoded',
        'Authorization': 'Basic ' + Buffer.from(SPOTIFY_CLIENT_ID + ':' + SPOTIFY_CLIENT_SECRET).toString('base64')
      },
      body: new URLSearchParams({
        grant_type: 'authorization_code',
        code: code,
        redirect_uri: REDIRECT_URI
      })
    });
    
    const data = await response.json();
    
    spotifyTokens.access_token = data.access_token;
    spotifyTokens.refresh_token = data.refresh_token;
    spotifyTokens.expires_at = Date.now() + (data.expires_in * 1000);
    
    console.log('[SPOTIFY] Connected successfully');
    res.send('<script>window.close();</script>');
  } catch (err) {
    console.error('[SPOTIFY] Auth error:', err);
    res.send('<script>window.close();</script>');
  }
});

app.get('/api/spotify/state', getUserFromSession, async (req, res) => {
  try {
    const state = await spotifyRequest('/me/player');
    
    if (!state) {
      return res.json({ connected: false });
    }
    
    res.json({
      connected: true,
      isPlaying: state.is_playing,
      volume: state.device.volume_percent
    });
  } catch (err) {
    res.json({ connected: false });
  }
});

app.post('/api/spotify/playpause', getUserFromSession, async (req, res) => {
  try {
    const state = await spotifyRequest('/me/player');
    
    if (state.is_playing) {
      await spotifyRequest('/me/player/pause', { method: 'PUT' });
    } else {
      await spotifyRequest('/me/player/play', { method: 'PUT' });
    }
    
    res.json({ success: true });
  } catch (err) {
    console.error('[SPOTIFY] Play/Pause error:', err);
    res.status(500).json({ error: err.message });
  }
});

app.post('/api/spotify/skip', getUserFromSession, async (req, res) => {
  try {
    await spotifyRequest('/me/player/next', { method: 'POST' });
    res.json({ success: true });
  } catch (err) {
    console.error('[SPOTIFY] Skip error:', err);
    res.status(500).json({ error: err.message });
  }
});

app.post('/api/spotify/volume', getUserFromSession, async (req, res) => {
  const { volume } = req.body;
  
  try {
    await spotifyRequest(`/me/player/volume?volume_percent=${volume}`, { method: 'PUT' });
    res.json({ success: true });
  } catch (err) {
    console.error('[SPOTIFY] Volume error:', err);
    res.status(500).json({ error: err.message });
  }
});
  </script>
  
  <!-- ==========================================
       CONTROLLER MODULE CODE
       ========================================== -->
  <script type="text/x-controller-module">
let spotifyInterval = null;
let spotifyConnected = false;

// Render UI
container.innerHTML = `
  <style>
    .spotify-connect-btn {
      width: 100%;
      padding: 12px;
      background: #1DB954;
      color: white;
      border: none;
      border-radius: 8px;
      font-size: 15px;
      font-weight: bold;
      cursor: pointer;
      transition: background 0.3s;
    }
    
    .spotify-connect-btn:hover {
      background: #1ed760;
    }
    
    .spotify-controls {
      background: #1a1a1a;
      padding: 15px;
      border-radius: 10px;
    }
    
    .spotify-volume-control {
      margin-bottom: 15px;
    }
    
    .spotify-volume-control label {
      display: block;
      margin-bottom: 8px;
      font-size: 14px;
      text-align: center;
    }
    
    .spotify-slider {
      width: 100%;
      height: 6px;
      border-radius: 3px;
      background: #3a3a3a;
      outline: none;
      -webkit-appearance: none;
    }
    
    .spotify-slider::-webkit-slider-thumb {
      -webkit-appearance: none;
      appearance: none;
      width: 18px;
      height: 18px;
      border-radius: 50%;
      background: #1DB954;
      cursor: pointer;
    }
    
    .spotify-slider::-moz-range-thumb {
      width: 18px;
      height: 18px;
      border-radius: 50%;
      background: #1DB954;
      cursor: pointer;
      border: none;
    }
    
    .spotify-music-buttons {
      display: flex;
      gap: 10px;
    }
    
    .spotify-btn-music {
      flex: 1;
      padding: 15px;
      border: none;
      border-radius: 8px;
      font-size: 20px;
      font-weight: bold;
      cursor: pointer;
      transition: all 0.3s;
    }
    
    .spotify-btn-pause {
      background: #555;
    }
    
    .spotify-btn-pause.paused {
      background: #444;
      opacity: 0.7;
    }
    
    .spotify-btn-pause.playing {
      background: #1DB954;
      animation: spotify-pulse 2s ease-in-out infinite;
    }
    
    @keyframes spotify-pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.7; }
    }
    
    .spotify-btn-skip {
      background: #FF9800;
    }
    
    .spotify-btn-skip:hover {
      background: #e68900;
    }
    
    .hidden {
      display: none !important;
    }
  </style>
  
  <div id="spotify-status">
    <button class="spotify-connect-btn" id="spotify-connect-btn">üéµ Connect Spotify</button>
  </div>
  
  <div class="spotify-controls hidden" id="spotify-controls">
    <div class="spotify-volume-control">
      <label>üîä Volume: <span id="spotify-volume-value">50</span>%</label>
      <input type="range" id="spotify-volume-slider" min="0" max="100" value="50" class="spotify-slider">
    </div>
    
    <div class="spotify-music-buttons">
      <button class="spotify-btn-music spotify-btn-pause paused" id="spotify-play-pause-btn">‚ùö‚ùö</button>
      <button class="spotify-btn-music spotify-btn-skip" id="spotify-skip-btn">‚è≠</button>
    </div>
  </div>
`;

const statusDiv = document.getElementById('spotify-status');
const controlsDiv = document.getElementById('spotify-controls');
const connectBtn = document.getElementById('spotify-connect-btn');
const volumeSlider = document.getElementById('spotify-volume-slider');
const volumeValue = document.getElementById('spotify-volume-value');
const playPauseBtn = document.getElementById('spotify-play-pause-btn');
const skipBtn = document.getElementById('spotify-skip-btn');

// Check Spotify connection
async function checkSpotifyConnection() {
  try {
    const res = await fetch(`${apiUrl}/api/spotify/state`, { headers: getHeaders() });
    const data = await res.json();
    
    if (data.connected) {
      spotifyConnected = true;
      statusDiv.classList.add('hidden');
      controlsDiv.classList.remove('hidden');
      volumeSlider.value = data.volume;
      volumeValue.textContent = data.volume;
    }
  } catch (err) {
    console.error('[SPOTIFY] Check error:', err);
  }
}

// Update Spotify status
async function updateSpotifyStatus() {
  if (!spotifyConnected) return;
  
  try {
    const res = await fetch(`${apiUrl}/api/spotify/state`, { headers: getHeaders() });
    const data = await res.json();
    
    if (data.isPlaying) {
      panel.style.borderColor = moduleConfig.activeColor;
      playPauseBtn.classList.remove('paused');
      playPauseBtn.classList.add('playing');
    } else {
      panel.style.borderColor = moduleConfig.borderColor;
      playPauseBtn.classList.remove('playing');
      playPauseBtn.classList.add('paused');
    }
  } catch (err) {
    console.error('[SPOTIFY] Status error:', err);
  }
}

// Event listeners
connectBtn.addEventListener('click', () => {
  window.open(`${apiUrl}/spotify/login`, '_blank', 'width=500,height=700');
  setTimeout(checkSpotifyConnection, 2000);
});

volumeSlider.addEventListener('input', async (e) => {
  const volume = parseInt(e.target.value);
  volumeValue.textContent = volume;
  
  try {
    await fetch(`${apiUrl}/api/spotify/volume`, {
      method: 'POST',
      headers: getHeaders(),
      body: JSON.stringify({ volume })
    });
  } catch (err) {
    console.error('[SPOTIFY] Volume error:', err);
  }
});

playPauseBtn.addEventListener('click', async () => {
  try {
    await fetch(`${apiUrl}/api/spotify/playpause`, {
      method: 'POST',
      headers: getHeaders()
    });
    setTimeout(updateSpotifyStatus, 200);
  } catch (err) {
    console.error('[SPOTIFY] Play/Pause error:', err);
  }
});

skipBtn.addEventListener('click', async () => {
  try {
    await fetch(`${apiUrl}/api/spotify/skip`, {
      method: 'POST',
      headers: getHeaders()
    });
  } catch (err) {
    console.error('[SPOTIFY] Skip error:', err);
  }
});

// Initialize
checkSpotifyConnection();
spotifyInterval = setInterval(updateSpotifyStatus, 2000);

// Return module instance
return {
  destroy: function() {
    if (spotifyInterval) {
      clearInterval(spotifyInterval);
    }
  }
};
  </script>
</head>
<body>
  <!-- This module has no OBS overlay, only controller UI -->
  <p style="text-align: center; padding: 40px; opacity: 0.5;">
    This page is a module for StreamDesk Controller.<br>
    Open /controller.html to use it.
  </p>
</body>
</html>
