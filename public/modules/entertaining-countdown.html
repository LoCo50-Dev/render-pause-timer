<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Entertaining Countdown</title>
  
  <!-- ==========================================
       MODULE CONFIGURATION
       ========================================== -->
  <script type="application/json" id="module-config">
  {
    "id": "entertaining-countdown",
    "name": "Entertaining Countdown",
    "type": "Addon",
    "priority": 0,
    "hasControllerUI": false,
    "hasOverlay": false,
    "dependencies": ["timer"]
  }
  </script>
  
  <!-- ==========================================
       SERVER MODULE CODE
       ========================================== -->
  <script type="text/x-server-module">
const fs = require('fs');
const path = require('path');

// Initialize entertainment state
if (!moduleStates.entertainingCountdown) {
  moduleStates.entertainingCountdown = {
    enabled: false,
    videos: [],
    usedVideos: []
  };
}

const entertainState = moduleStates.entertainingCountdown;

// Scan videos recursively
function scanVideos(dir, baseDir = dir) {
  let videos = [];
  
  try {
    if (!fs.existsSync(dir)) {
      fs.mkdirSync(dir, { recursive: true });
      return videos;
    }
    
    const items = fs.readdirSync(dir);
    
    for (const item of items) {
      const fullPath = path.join(dir, item);
      const stat = fs.statSync(fullPath);
      
      if (stat.isDirectory()) {
        videos = videos.concat(scanVideos(fullPath, baseDir));
      } else if (stat.isFile()) {
        const ext = path.extname(item).toLowerCase();
        const videoExtensions = ['.mp4', '.webm', '.ogg', '.mov', '.avi', '.mkv', '.m4v'];
        
        if (videoExtensions.includes(ext)) {
          const relativePath = path.relative(baseDir, fullPath).replace(/\\/g, '/');
          videos.push({
            filename: item,
            path: relativePath,
            fullPath: fullPath
          });
        }
      }
    }
  } catch (err) {
    console.error('[ENTERTAINING] Error scanning videos:', err);
  }
  
  return videos;
}

// Scan on startup
const vidsDir = path.join(__dirname, 'public', 'vids');
entertainState.videos = scanVideos(vidsDir);
console.log(`[ENTERTAINING] Scanned ${entertainState.videos.length} videos from /vids`);

// Routes
app.get('/api/entertaining/videos', (req, res) => {
  res.json({ videos: entertainState.videos });
});

app.get('/api/entertaining/state', getUserFromSession, (req, res) => {
  res.json({
    enabled: entertainState.enabled,
    usedVideos: entertainState.usedVideos
  });
});

app.post('/api/entertaining/state', getUserFromSession, (req, res) => {
  const { enabled } = req.body;
  
  if (typeof enabled !== 'undefined') {
    entertainState.enabled = enabled;
    console.log(`[ENTERTAINING] ${enabled ? 'Enabled' : 'Disabled'}`);
  }
  
  res.json({ enabled: entertainState.enabled });
});

app.post('/api/entertaining/reset-used', getUserFromSession, (req, res) => {
  entertainState.usedVideos = [];
  console.log('[ENTERTAINING] Reset used videos');
  res.json({ success: true });
});

app.post('/api/entertaining/mark-used', (req, res) => {
  const { videoPath } = req.body;
  
  if (videoPath && !entertainState.usedVideos.includes(videoPath)) {
    entertainState.usedVideos.push(videoPath);
    console.log(`[ENTERTAINING] Marked as used: ${videoPath}`);
  }
  
  res.json({ success: true });
});

app.get('/api/entertaining/public', (req, res) => {
  res.json({
    enabled: entertainState.enabled,
    videos: entertainState.videos,
    usedVideos: entertainState.usedVideos
  });
});
  </script>
  
  <!-- ==========================================
       NO OVERLAY - Entertainment is integrated into countdown.html
       ========================================== -->
</head>
<body>
  <p style="color: white; text-align: center; padding: 50px;">
    Entertainment Countdown Addon is active.<br>
    This addon provides video playback integrated into the timer countdown.<br>
    No separate overlay needed.
  </p>
</body>
</html>
