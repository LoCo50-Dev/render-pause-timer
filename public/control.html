<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>StreamDesk Control V13</title>
  
  <link rel="icon" type="image/x-icon" href="/assets/icon.ico">
  <link rel="apple-touch-icon" href="/assets/icon.ico">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-title" content="StreamDesk">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="theme-color" content="#2a2a2a">
  
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      font-family: Arial, sans-serif;
      background: transparent;
      color: white;
      padding: 20px;
      display: flex;
      justify-content: center;
      align-items: center;
      min-height: 100vh;
    }
    
    /* ========== LOGIN SCREEN ========== */
    
    .login-screen {
      background: #2a2a2a;
      border-radius: 15px;
      padding: 30px;
      max-width: 320px;
      width: 100%;
      box-shadow: 0 4px 20px rgba(0,0,0,0.5);
      text-align: center;
    }
    
    .login-screen h2 {
      margin-bottom: 20px;
      font-size: 24px;
    }
    
    .login-screen p {
      margin-bottom: 20px;
      opacity: 0.7;
      font-size: 14px;
    }
    
    .code-input {
      width: 100%;
      padding: 15px;
      font-size: 24px;
      letter-spacing: 8px;
      text-align: center;
      background: #1a1a1a;
      border: 2px solid #3a3a3a;
      border-radius: 8px;
      color: white;
      margin-bottom: 15px;
    }
    
    .code-input:focus {
      outline: none;
      border-color: #4CAF50;
    }
    
    .btn-login {
      width: 100%;
      padding: 15px;
      background: #4CAF50;
      color: white;
      border: none;
      border-radius: 8px;
      font-size: 16px;
      font-weight: bold;
      cursor: pointer;
      transition: background 0.3s;
    }
    
    .btn-login:hover {
      background: #45a049;
    }
    
    .btn-login:disabled {
      background: #666;
      cursor: not-allowed;
    }
    
    .error-message {
      color: #f44336;
      margin-top: 10px;
      font-size: 14px;
      display: none;
    }
    
    .error-message.show {
      display: block;
    }
    
    /* ========== USER PROFILE BOX ========== */
    
    .user-profile-box {
      position: fixed;
      top: 20px;
      left: 50%;
      transform: translateX(-50%);
      padding: 3px;
      display: flex;
      align-items: center;
      box-shadow: 0 4px 20px rgba(0,0,0,0.5);
      z-index: 1000;
      border-radius: 18px;
      background: linear-gradient(
        90deg,
        #ff0000, #ff7f00, #ffff00, #00ff00, #0000ff, #4b0082, #9400d3,
        #ff0000, #ff7f00, #ffff00, #00ff00, #0000ff, #4b0082, #9400d3, #ff0000
      );
      background-size: 300% 100%;
      animation: rainbow-flow 15s linear infinite;
    }
    
    .user-profile-inner {
      background: #2a2a2a;
      border-radius: 15px;
      padding: 10px 20px;
      display: flex;
      align-items: center;
      gap: 12px;
    }
    
    @keyframes rainbow-flow {
      0% { background-position: 0% 0%; }
      100% { background-position: 300% 0%; }
    }
    
    .user-avatar {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      object-fit: cover;
      border: 2px solid #4CAF50;
    }
    
    .user-name {
      font-size: 14px;
      font-weight: bold;
      color: white;
    }
    
    /* ========== LANGUAGE SELECTOR ========== */
    
    .language-selector {
      position: fixed;
      top: 80px;
      right: 20px;
      display: flex;
      gap: 8px;
      z-index: 1000;
    }
    
    .btn-language {
      padding: 0;
      border: 2px solid #3a3a3a;
      border-radius: 8px;
      cursor: pointer;
      background: #2a2a2a;
      transition: all 0.3s;
      overflow: hidden;
      width: 50px;
      height: 35px;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    .btn-language.active {
      border-color: #FF9800;
      box-shadow: 0 0 10px rgba(255, 152, 0, 0.3);
    }
    
    .btn-language:hover {
      background: #3a3a3a;
    }
    
    .flag-img {
      width: 100%;
      height: 100%;
      object-fit: cover;
      display: block;
    }
    
    /* ========== MODULE CHOICE DIALOG ========== */
    
    .module-choice-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.8);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 2000;
    }
    
    .module-choice-dialog {
      background: #2a2a2a;
      border-radius: 15px;
      padding: 30px;
      max-width: 400px;
      width: 90%;
      box-shadow: 0 8px 32px rgba(0,0,0,0.7);
    }
    
    .module-choice-dialog h3 {
      margin-bottom: 10px;
      font-size: 20px;
      text-align: center;
    }
    
    .module-choice-dialog p {
      margin-bottom: 25px;
      opacity: 0.7;
      font-size: 14px;
      text-align: center;
    }
    
    .module-choice-buttons {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }
    
    .btn-module-choice {
      padding: 15px;
      background: #3a3a3a;
      color: white;
      border: 2px solid #555;
      border-radius: 8px;
      font-size: 16px;
      font-weight: bold;
      cursor: pointer;
      transition: all 0.3s;
    }
    
    .btn-module-choice:hover {
      background: #4a4a4a;
      border-color: #00BCD4;
    }
    
    .btn-module-choice.spotify {
      border-color: #1DB954;
    }
    
    .btn-module-choice.spotify:hover {
      background: #1DB954;
    }
    
    .btn-module-choice.playlist {
      border-color: #9C27B0;
    }
    
    .btn-module-choice.playlist:hover {
      background: #9C27B0;
    }
    
    /* ========== MAIN CONTAINER ========== */
    
    .container {
      display: flex;
      flex-direction: column;
      gap: 15px;
      width: 100%;
      max-width: 320px;
      margin-top: 80px;
    }
    
    .hidden {
      display: none !important;
    }
    
    /* ========== CONTROL PANEL (Generic styles for modules) ========== */
    
    .control-panel {
      background: #2a2a2a;
      border-radius: 15px;
      padding: 18px;
      width: 100%;
      box-shadow: 0 4px 20px rgba(0,0,0,0.5);
      transition: padding 0.3s ease, border-color 0.5s ease;
      border: 2px solid #3a3a3a;
    }
    
    .control-panel.collapsed {
      padding: 8px 12px;
    }
    
    .panel-header {
      display: flex;
      align-items: center;
      gap: 8px;
      cursor: pointer;
      user-select: none;
      margin-bottom: 11px;
      padding: 0;
    }
    
    .panel-header.collapsed {
      margin-bottom: 0;
    }
    
    .panel-arrow {
      font-size: 16px;
      transition: transform 0.3s ease;
      color: white;
      line-height: 1;
    }
    
    .panel-arrow.collapsed {
      transform: rotate(-90deg);
    }
    
    .panel-title {
      font-size: 12px;
      font-weight: bold;
      opacity: 1;
      transition: opacity 0.3s ease;
      line-height: 1;
    }
    
    .panel-title.hidden {
      opacity: 0;
    }
    
    .panel-content {
      max-height: 1000px;
      overflow: hidden;
      transition: max-height 0.3s ease, opacity 0.3s ease;
      opacity: 1;
    }
    
    .panel-content.collapsed {
      max-height: 0;
      opacity: 0;
    }
    
    /* ========== LOADING ========== */
    
    .loading {
      text-align: center;
      padding: 40px;
      opacity: 0.7;
    }
    
    /* ========== MODULE ERROR ========== */
    
    .module-error {
      background: rgba(244, 67, 54, 0.1);
      border: 2px solid #f44336;
      border-radius: 8px;
      padding: 15px;
      margin: 10px 0;
      color: #f44336;
      font-size: 13px;
    }
    
    .module-error strong {
      display: block;
      margin-bottom: 5px;
    }
  </style>
</head>
<body>
  <!-- ========== LOGIN SCREEN ========== -->
  <div class="login-screen" id="loginScreen">
    <h2>üîê StreamDesk</h2>
    <p>Enter your 6-digit code</p>
    <input type="text" class="code-input" id="codeInput" maxlength="6" placeholder="000000" autofocus>
    <button class="btn-login" id="btnLogin">Login</button>
    <div class="error-message" id="errorMessage">Invalid code. Please try again.</div>
  </div>

  <!-- ========== USER PROFILE BOX ========== -->
  <div class="user-profile-box hidden" id="userProfileBox">
    <div class="user-profile-inner">
      <img src="/user/none.png" alt="User Avatar" class="user-avatar" id="userAvatar">
      <span class="user-name" id="userName">Guest</span>
    </div>
  </div>

  <!-- ========== LANGUAGE SELECTOR ========== -->
  <div class="language-selector hidden" id="languageSelector">
    <button class="btn-language active" id="btn-german" data-lang="de">
      <img src="/assets/de.webp" alt="Deutsch" class="flag-img">
    </button>
    <button class="btn-language" id="btn-english" data-lang="en">
      <img src="/assets/en.webp" alt="English" class="flag-img">
    </button>
  </div>

  <!-- ========== MAIN CONTAINER (Modules load here) ========== -->
  <div class="container hidden" id="mainContainer">
    <div class="loading">Loading modules...</div>
  </div>

  <script>
    const API_URL = window.location.origin;
    let sessionId = null;
    let loadedModules = [];
    let currentLanguage = 'de';
    let moduleChoices = {}; // Store user's module choices
    
    // ========== DOM ELEMENTS ==========
    const loginScreen = document.getElementById('loginScreen');
    const mainContainer = document.getElementById('mainContainer');
    const codeInput = document.getElementById('codeInput');
    const btnLogin = document.getElementById('btnLogin');
    const errorMessage = document.getElementById('errorMessage');
    const userProfileBox = document.getElementById('userProfileBox');
    const userAvatar = document.getElementById('userAvatar');
    const userName = document.getElementById('userName');
    const languageSelector = document.getElementById('languageSelector');
    const btnGerman = document.getElementById('btn-german');
    const btnEnglish = document.getElementById('btn-english');
    
    // ========== UTILITY FUNCTIONS ==========
    
    function generateSessionId() {
      return 'session_' + Math.random().toString(36).substring(2, 15) + 
             Math.random().toString(36).substring(2, 15) + Date.now();
    }
    
    function getHeaders() {
      const headers = { 'Content-Type': 'application/json' };
      if (sessionId) {
        headers['X-Session-Id'] = sessionId;
      }
      return headers;
    }
    
    // ========== LANGUAGE FUNCTIONS ==========
    
    async function changeLanguage(lang) {
      currentLanguage = lang;
      
      if (lang === 'de') {
        btnGerman.classList.add('active');
        btnEnglish.classList.remove('active');
      } else {
        btnEnglish.classList.add('active');
        btnGerman.classList.remove('active');
      }
      
      // Update timer language if timer module exists
      try {
        await fetch(`${API_URL}/api/timer/language`, {
          method: 'POST',
          headers: getHeaders(),
          body: JSON.stringify({ language: lang })
        });
      } catch (err) {
        // Timer module might not exist, ignore error
      }
    }
    
    btnGerman.addEventListener('click', () => changeLanguage('de'));
    btnEnglish.addEventListener('click', () => changeLanguage('en'));
    
    // ========== AUTH FUNCTIONS ==========
    
    async function checkAuthStatus() {
      try {
        const res = await fetch(`${API_URL}/api/instance/info`);
        const data = await res.json();
        
        if (!data.authRequired) {
          sessionId = generateSessionId();
          const loginRes = await fetch(`${API_URL}/api/auth/verify`, {
            method: 'POST',
            headers: getHeaders(),
            body: JSON.stringify({ code: '000000', sessionId })
          });
          const loginData = await loginRes.json();
          
          if (loginData.success) {
            showMainContainer(loginData.user);
          }
        } else {
          loginScreen.classList.remove('hidden');
        }
      } catch (err) {
        console.error('[AUTH] Check error:', err);
        loginScreen.classList.remove('hidden');
      }
    }
    
    async function login() {
      const code = codeInput.value.trim();
      
      if (code.length !== 6 || !/^\d+$/.test(code)) {
        errorMessage.classList.add('show');
        return;
      }
      
      btnLogin.disabled = true;
      btnLogin.textContent = 'Logging in...';
      sessionId = generateSessionId();
      
      try {
        const res = await fetch(`${API_URL}/api/auth/verify`, {
          method: 'POST',
          headers: getHeaders(),
          body: JSON.stringify({ code, sessionId })
        });
        
        const data = await res.json();
        
        if (data.success) {
          errorMessage.classList.remove('show');
          showMainContainer(data.user);
        } else {
          errorMessage.classList.add('show');
          codeInput.value = '';
          codeInput.focus();
          sessionId = null;
        }
      } catch (err) {
        console.error('[AUTH] Login error:', err);
        errorMessage.textContent = 'Connection error. Please try again.';
        errorMessage.classList.add('show');
        sessionId = null;
      } finally {
        btnLogin.disabled = false;
        btnLogin.textContent = 'Login';
      }
    }
    
    btnLogin.addEventListener('click', login);
    codeInput.addEventListener('keypress', (e) => {
      if (e.key === 'Enter') login();
    });
    codeInput.addEventListener('input', () => {
      errorMessage.classList.remove('show');
    });
    
    // ========== MODULE CHOICE DIALOG ==========
    
    function showModuleChoice(conflictingModules, priority) {
      return new Promise((resolve) => {
        const overlay = document.createElement('div');
        overlay.className = 'module-choice-overlay';
        
        const dialog = document.createElement('div');
        dialog.className = 'module-choice-dialog';
        
        dialog.innerHTML = `
          <h3>‚öôÔ∏è Module Selection</h3>
          <p>Multiple modules found for the same function. Which one would you like to use?</p>
          <div class="module-choice-buttons" id="choiceButtons"></div>
        `;
        
        overlay.appendChild(dialog);
        document.body.appendChild(overlay);
        
        const buttonsContainer = document.getElementById('choiceButtons');
        
        conflictingModules.forEach(mod => {
          const btn = document.createElement('button');
          btn.className = `btn-module-choice ${mod.id}`;
          btn.textContent = `${mod.name} (${mod.id})`;
          btn.addEventListener('click', () => {
            moduleChoices[priority] = mod.id;
            document.body.removeChild(overlay);
            resolve(mod);
          });
          buttonsContainer.appendChild(btn);
        });
      });
    }
    
    // ========== MODULE LOADER ==========
    
    async function loadModules() {
      try {
        console.log('[MODULE LOADER] Fetching module list...');
        const res = await fetch(`${API_URL}/api/modules/list`);
        const data = await res.json();
        
        console.log('[MODULE LOADER] Modules:', data.modules);
        
        // Filter only modules with Controller UI
        const modulesWithUI = data.modules.filter(m => m.hasControllerUI !== false);
        
        // Group by priority to detect conflicts
        const priorityGroups = {};
        modulesWithUI.forEach(mod => {
          if (!priorityGroups[mod.priority]) {
            priorityGroups[mod.priority] = [];
          }
          priorityGroups[mod.priority].push(mod);
        });
        
        // Clear loading message
        mainContainer.innerHTML = '';
        
        if (modulesWithUI.length === 0) {
          mainContainer.innerHTML = '<div class="loading">No modules found in /public/modules/</div>';
          return;
        }
        
        // Handle conflicts and load modules
        const modulesToLoad = [];
        
        for (const [priority, modules] of Object.entries(priorityGroups)) {
          if (modules.length > 1) {
            // Conflict detected - ask user
            console.log(`[MODULE LOADER] Conflict at priority ${priority}:`, modules.map(m => m.name));
            
            // Check if user already made a choice
            if (moduleChoices[priority]) {
              const chosen = modules.find(m => m.id === moduleChoices[priority]);
              if (chosen) {
                modulesToLoad.push(chosen);
              } else {
                // Stored choice no longer available, ask again
                const selected = await showModuleChoice(modules, priority);
                modulesToLoad.push(selected);
              }
            } else {
              // Ask user to choose
              const selected = await showModuleChoice(modules, priority);
              modulesToLoad.push(selected);
            }
          } else {
            // No conflict, load the single module
            modulesToLoad.push(modules[0]);
          }
        }
        
        // Sort by priority
        modulesToLoad.sort((a, b) => a.priority - b.priority);
        
        // Load each selected module
        for (const moduleInfo of modulesToLoad) {
          await loadModule(moduleInfo);
        }
        
        console.log('[MODULE LOADER] ‚úÖ All modules loaded');
      } catch (err) {
        console.error('[MODULE LOADER] ‚ùå Error:', err);
        mainContainer.innerHTML = '<div class="loading">Error loading modules</div>';
      }
    }
    
    async function loadModule(moduleInfo) {
      try {
        console.log(`[MODULE LOADER] Loading ${moduleInfo.name}...`);
        
        // Check dependencies
        if (moduleInfo.dependencies && moduleInfo.dependencies.length > 0) {
          const missingDeps = moduleInfo.dependencies.filter(dep => 
            !loadedModules.find(m => m.id === dep)
          );
          
          if (missingDeps.length > 0) {
            console.warn(`[MODULE LOADER] ‚ö†Ô∏è ${moduleInfo.name} missing dependencies: ${missingDeps.join(', ')}`);
          }
        }
        
        // Fetch module details (including controller code)
        const res = await fetch(`${API_URL}/api/modules/${moduleInfo.id}`);
        const moduleData = await res.json();
        
        if (!moduleData.controllerCode) {
          console.warn(`[MODULE LOADER] ‚ö†Ô∏è No controller code for ${moduleInfo.id}`);
          return;
        }
        
        // Create panel container
        const panel = document.createElement('div');
        panel.className = 'control-panel collapsed';
        panel.id = `${moduleInfo.id}-panel`;
        panel.style.borderColor = moduleInfo.borderColor || '#3a3a3a';
        
        // Create header
        const header = document.createElement('div');
        header.className = 'panel-header collapsed';
        header.innerHTML = `
          <span class="panel-arrow collapsed">ÀÖ</span>
          <span class="panel-title">${moduleInfo.name}</span>
        `;
        
        // Create content container
        const content = document.createElement('div');
        content.className = 'panel-content collapsed';
        content.id = `${moduleInfo.id}-content`;
        
        panel.appendChild(header);
        panel.appendChild(content);
        mainContainer.appendChild(panel);
        
        // Toggle functionality
        header.addEventListener('click', () => {
          togglePanel(header, content, panel);
        });
        
        // Execute module controller code
        try {
          const moduleScope = {
            container: content,
            panel: panel,
            apiUrl: API_URL,
            sessionId: sessionId,
            getHeaders: getHeaders,
            moduleConfig: moduleData.config,
            console: console,
            document: document,
            window: window,
            fetch: fetch,
            setInterval: setInterval,
            clearInterval: clearInterval,
            setTimeout: setTimeout,
            clearTimeout: clearTimeout,
            Math: Math,
            Date: Date,
            JSON: JSON,
            parseInt: parseInt,
            parseFloat: parseFloat
          };
          
          const moduleFunction = new Function(
            ...Object.keys(moduleScope),
            moduleData.controllerCode
          );
          
          const moduleInstance = moduleFunction(...Object.values(moduleScope));
          
          // Store module instance
          loadedModules.push({
            id: moduleInfo.id,
            instance: moduleInstance,
            panel: panel,
            content: content
          });
          
          console.log(`[MODULE LOADER] ‚úÖ ${moduleInfo.name} loaded`);
        } catch (err) {
          console.error(`[MODULE LOADER] ‚ùå Error executing ${moduleInfo.id}:`, err);
          content.innerHTML = `
            <div class="module-error">
              <strong>Error loading module</strong>
              ${err.message}
            </div>
          `;
        }
      } catch (err) {
        console.error(`[MODULE LOADER] ‚ùå Error loading ${moduleInfo.id}:`, err);
      }
    }
    
    function togglePanel(header, content, panel) {
      const arrow = header.querySelector('.panel-arrow');
      const title = header.querySelector('.panel-title');
      const isCollapsed = content.classList.contains('collapsed');
      
      if (isCollapsed) {
        content.classList.remove('collapsed');
        arrow.classList.remove('collapsed');
        header.classList.remove('collapsed');
        panel.classList.remove('collapsed');
        title.classList.add('hidden');
      } else {
        content.classList.add('collapsed');
        arrow.classList.add('collapsed');
        header.classList.add('collapsed');
        panel.classList.add('collapsed');
        title.classList.remove('hidden');
      }
    }
    
    // ========== SHOW MAIN CONTAINER ==========
    
    function showMainContainer(user) {
      loginScreen.classList.add('hidden');
      mainContainer.classList.remove('hidden');
      userProfileBox.classList.remove('hidden');
      languageSelector.classList.remove('hidden');
      
      if (user) {
        userName.textContent = user.name;
        userAvatar.src = `/user/${user.avatar}`;
        userAvatar.onerror = () => { userAvatar.src = '/user/none.png'; };
      }
      
      loadModules();
    }
    
    // ========== START APP ==========
    
    checkAuthStatus();
  </script>
</body>
</html>
